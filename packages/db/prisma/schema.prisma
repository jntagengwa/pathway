generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- Enums ---

enum Role {
  ADMIN
  COORDINATOR
  TEACHER
  PARENT
}

enum AssignmentStatus {
  PENDING
  CONFIRMED
  DECLINED
}

enum SwapStatus {
  REQUESTED
  ACCEPTED
  DECLINED
  CANCELLED
}

enum Weekday {
  SUN
  MON
  TUE
  WED
  THU
  FRI
  SAT
}

enum AnnouncementAudience {
  ALL
  PARENTS
  STAFF
}

// NEW: Org-level roles (optional, for suites/billing admins)
enum OrgRole {
  ORG_ADMIN
  ORG_BILLING
  ORG_MEMBER
}

// NEW: Billing provider and subscription status
enum BillingProvider {
  STRIPE
  GOCARDLESS
}

enum SubscriptionStatus {
  TRIALING
  ACTIVE
  PAST_DUE
  CANCELED
  INCOMPLETE
}

enum AuditAction {
  CREATED
  UPDATED
  DELETED
  VIEWED
}

enum AuditEntityType {
  CONCERN
  CHILD_NOTE
}

// --- Models ---

// NEW: Org (Suite) — business/billing owner; may contain multiple Tenants (sites)
model Org {
  id               String   @id @default(uuid())
  name             String
  slug             String   @unique
  planCode         String   // e.g., trial|starter|standard|pro|suite_*
  isSuite          Boolean  @default(false)
  stripeCustomerId String?  @unique
  tenants          Tenant[]
  subscriptions    Subscription[]
  entitlements     OrgEntitlementSnapshot[]
  usageCounters    UsageCounters[]
  billingEvents    BillingEvent[]
  userOrgRoles     UserOrgRole[]
  auditEvents      AuditEvent[]
  staffActivities  StaffActivity[]
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model Tenant {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique

  // NEW: link tenant (site) to its owning Org
  orgId     String
  org       Org      @relation(fields: [orgId], references: [id])

  users     User[]
  groups    Group[]
  children  Child[]
  roles     UserTenantRole[]
  sessions      Session[]
  lessons       Lesson[]
  announcements Announcement[]
  preferences   VolunteerPreference[]
  auditEvents   AuditEvent[]
  staffActivities StaffActivity[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orgId])
}

model UserTenantRole {
  id       String @id @default(uuid())
  userId   String
  tenantId String
  role     Role

  user   User   @relation(fields: [userId], references: [id])
  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@unique([userId, tenantId, role])
}

// NEW: User ↔ Org roles (optional, for suite-level administration)
model UserOrgRole {
  id     String  @id @default(uuid())
  userId String
  orgId  String
  role   OrgRole

  user User @relation(fields: [userId], references: [id])
  org  Org  @relation(fields: [orgId], references: [id])

  @@unique([userId, orgId, role])
  @@index([orgId])
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?

  // NOTE: kept for backward compatibility (single-tenant user). For suites, prefer UserTenantRole.
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])

  children  Child[]  @relation("ParentChildren")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  hasServeAccess Boolean @default(false)
  hasFamilyAccess Boolean @default(false)
  roles    UserTenantRole[]
  assignments Assignment[]
  preferences VolunteerPreference[]
  notes       ChildNote[] @relation("ChildNoteAuthor")
  approvedNotes ChildNote[] @relation("ChildNoteApprovedBy")
  auditEvents AuditEvent[] @relation("AuditActor")
  swapRequestsFrom SwapRequest[] @relation("SwapFromUser")
  swapRequestsTo   SwapRequest[] @relation("SwapToUser")
  orgRoles  UserOrgRole[]
  staffActivities StaffActivity[]
}

model Child {
  id         String      @id @default(uuid())
  firstName  String
  lastName   String
  allergies  String @default("unknown")
  photoKey   String?
  notes      String?
  tenantId   String
  tenant     Tenant      @relation(fields: [tenantId], references: [id])
  guardians  User[]      @relation("ParentChildren")
  groupId    String?
  group      Group?      @relation(fields: [groupId], references: [id])
  disabilities String[]  @default([])
  concerns     Concern[]
  attendance   Attendance[]
  childNotes   ChildNote[]
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt

  @@index([tenantId])
}

model Group {
  id        String   @id @default(uuid())
  name      String
  minAge    Int
  maxAge    Int
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  children  Child[]
  attendances Attendance[]
  sessions    Session[]
  lessons     Lesson[]

  @@index([tenantId])
}

model Attendance {
  id        String   @id @default(uuid())
  childId   String
  child     Child    @relation(fields: [childId], references: [id])
  groupId   String
  group     Group    @relation(fields: [groupId], references: [id])
  sessionId String?
  session   Session? @relation(fields: [sessionId], references: [id])
  present   Boolean
  timestamp DateTime @default(now())

  @@index([childId])
  @@index([sessionId])
  @@index([groupId])
}

model Concern {
  id        String   @id @default(uuid())
  childId   String
  child     Child    @relation(fields: [childId], references: [id])
  summary   String
  details   String?
  deletedAt DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([childId])
}

model Session {
  id         String   @id @default(uuid())
  tenantId   String
  tenant     Tenant   @relation(fields: [tenantId], references: [id])
  groupId    String?
  group      Group?   @relation(fields: [groupId], references: [id])
  startsAt   DateTime
  endsAt     DateTime
  title      String?
  assignments Assignment[]
  attendances Attendance[]
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([tenantId])
  @@index([groupId])
  @@index([startsAt])
}

model Assignment {
  id         String   @id @default(uuid())
  sessionId  String
  session    Session  @relation(fields: [sessionId], references: [id])
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  role       Role
  status     AssignmentStatus @default(CONFIRMED)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  swapRequests SwapRequest[] @relation("AssignmentSwapRequests")

  @@unique([sessionId, userId, role])
  @@index([userId])
}

model VolunteerPreference {
  id           String  @id @default(uuid())
  userId       String
  user         User    @relation(fields: [userId], references: [id])
  tenantId     String
  tenant       Tenant  @relation(fields: [tenantId], references: [id])
  weekday      Weekday
  startMinute  Int     // minutes from 00:00 (0-1439)
  endMinute    Int     // minutes from 00:00 (1-1440)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([tenantId])
  @@unique([userId, tenantId, weekday, startMinute, endMinute])
}

model SwapRequest {
  id            String   @id @default(uuid())
  assignmentId  String
  assignment    Assignment @relation("AssignmentSwapRequests", fields: [assignmentId], references: [id])
  fromUserId    String
  fromUser      User     @relation("SwapFromUser", fields: [fromUserId], references: [id])
  toUserId      String?
  toUser        User?    @relation("SwapToUser", fields: [toUserId], references: [id])
  status        SwapStatus @default(REQUESTED)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([fromUserId])
  @@index([toUserId])
}

model Lesson {
  id         String   @id @default(uuid())
  tenantId   String
  tenant     Tenant   @relation(fields: [tenantId], references: [id])
  groupId    String?
  group      Group?   @relation(fields: [groupId], references: [id])
  title      String
  description String?
  fileKey    String?   // storage key for uploaded content
  weekOf     DateTime  // e.g., Monday of the week
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([tenantId])
  @@index([groupId])
  @@index([weekOf])
}

model Announcement {
  id         String   @id @default(uuid())
  tenantId   String
  tenant     Tenant   @relation(fields: [tenantId], references: [id])
  title      String
  body       String
  audience   AnnouncementAudience @default(ALL)
  publishedAt DateTime?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([tenantId])
  @@index([publishedAt])
  @@index([tenantId, audience, publishedAt])
}

model ChildNote {
  id         String   @id @default(uuid())
  childId    String
  child      Child    @relation(fields: [childId], references: [id])
  authorId   String
  author     User     @relation("ChildNoteAuthor", fields: [authorId], references: [id])
  text       String
  visibleToParents Boolean @default(false)
  approvedByUserId String?
  approvedBy User? @relation("ChildNoteApprovedBy", fields: [approvedByUserId], references: [id])
  approvedAt DateTime?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([childId])
  @@index([authorId])
}

model AuditEvent {
  id           String          @id @default(uuid())
  createdAt    DateTime        @default(now())
  tenantId     String
  tenant       Tenant          @relation(fields: [tenantId], references: [id])
  orgId        String
  org          Org             @relation(fields: [orgId], references: [id])
  actorUserId  String
  actor        User            @relation("AuditActor", fields: [actorUserId], references: [id])
  entityType   AuditEntityType
  entityId     String?
  action       AuditAction
  metadata     Json?

  @@index([tenantId, createdAt])
  @@index([orgId, createdAt])
  @@index([actorUserId, createdAt])
  @@index([entityType, entityId])
}

// --- Billing & Entitlements ---

model Subscription {
  id               String   @id @default(uuid())
  orgId            String
  org              Org      @relation(fields: [orgId], references: [id])
  provider         BillingProvider
  providerSubId    String   @unique
  planCode         String
  status           SubscriptionStatus
  periodStart      DateTime
  periodEnd        DateTime
  cancelAtPeriodEnd Boolean  @default(false)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@index([orgId])
  @@index([status])
  @@index([planCode])
}

model OrgEntitlementSnapshot {
  id                  String   @id @default(uuid())
  orgId               String
  org                 Org      @relation(fields: [orgId], references: [id])
  maxSites            Int
  av30Included        Int
  leaderSeatsIncluded Int
  storageGbIncluded   Int
  flagsJson           Json?
  source              String   // e.g., trial, subscription(pro), manual_override
  createdAt           DateTime @default(now())

  @@index([orgId, createdAt])
}

model UsageCounters {
  id              String   @id @default(uuid())
  orgId           String
  org             Org      @relation(fields: [orgId], references: [id])
  av30            Int      @default(0)
  storageGb       Int      @default(0)
  smsMonth        Int      @default(0)
  exportsMonth    Int      @default(0)
  calculatedAt    DateTime @default(now())

  @@index([orgId, calculatedAt])
}

model BillingEvent {
  id        String   @id @default(uuid())
  orgId     String?
  org       Org?     @relation(fields: [orgId], references: [id])
  provider  BillingProvider
  type      String
  payloadJson Json
  createdAt DateTime @default(now())

  @@index([orgId, createdAt])
}

model StaffActivity {
  id           String   @id @default(uuid())
  tenantId     String
  tenant       Tenant   @relation(fields: [tenantId], references: [id])
  orgId        String
  org          Org      @relation(fields: [orgId], references: [id])
  staffUserId  String
  staffUser    User     @relation(fields: [staffUserId], references: [id])
  activityType String   // Av30ActivityType enum value
  occurredAt   DateTime @default(now())
  createdAt    DateTime @default(now())

  @@index([tenantId, occurredAt])
  @@index([tenantId, staffUserId, occurredAt])
  @@index([orgId, occurredAt])
  @@index([orgId, staffUserId, occurredAt])
}