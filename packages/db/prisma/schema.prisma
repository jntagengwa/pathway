generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- Enums ---

enum Role {
  ADMIN
  COORDINATOR
  TEACHER
  PARENT
  LEAD
  SUPPORT
}

enum AssignmentStatus {
  PENDING
  CONFIRMED
  DECLINED
}

enum SwapStatus {
  REQUESTED
  ACCEPTED
  DECLINED
  CANCELLED
}

enum Weekday {
  SUN
  MON
  TUE
  WED
  THU
  FRI
  SAT
}

enum AnnouncementAudience {
  ALL
  PARENTS
  STAFF
}

// NEW: Org-level roles (optional, for suites/billing admins)
enum OrgRole {
  ORG_ADMIN
  ORG_BILLING
  ORG_MEMBER
}

// NEW: Site-level membership roles (Site == Tenant boundary for RLS)
enum SiteRole {
  SITE_ADMIN
  STAFF
  VIEWER
}

// NEW: Billing provider and subscription status
enum BillingProvider {
  STRIPE
  GOCARDLESS
}

enum SubscriptionStatus {
  TRIALING
  ACTIVE
  PAST_DUE
  CANCELED
  INCOMPLETE
}

enum PendingOrderStatus {
  PENDING
  COMPLETED
  CANCELLED
}

enum AuditAction {
  CREATED
  UPDATED
  DELETED
  VIEWED
}

enum AuditEntityType {
  CONCERN
  CHILD_NOTE
}

enum LeadKind {
  DEMO
  TOOLKIT
  TRIAL
  READINESS
}

// --- Blog (platform-wide, not tenant-scoped) ---

enum BlogPostStatus {
  DRAFT
  SCHEDULED
  PUBLISHED
  ARCHIVED
}

enum BlogAssetType {
  THUMBNAIL
  HEADER
  INLINE
}

enum BlogAssetStorage {
  POSTGRES
}

model BlogAsset {
  id        String           @id @default(uuid())
  type      BlogAssetType
  storage   BlogAssetStorage  @default(POSTGRES)
  mimeType  String
  byteSize  Int
  sha256    String           @unique
  width     Int?
  height    Int?
  bytes     Bytes
  createdAt DateTime         @default(now())

  @@index([sha256])
}

model BlogPost {
  id                 String         @id @default(uuid())
  title              String
  slug               String         @unique
  excerpt            String?        @db.Text
  contentJson        Json
  contentHtml        String         @db.Text
  seoTitle           String?
  seoDescription     String?        @db.Text
  thumbnailImageId   String?
  headerImageId      String?
  status             BlogPostStatus @default(DRAFT)
  publishedAt        DateTime?
  tags               String[]       @default([])
  authorName         String?        // Set at publish from publishing user
  authorAvatarId     String?        // BlogAsset id if avatar stored at publish
  readTimeMinutes    Int?           // Calculated from content at publish
  isFeatured         Boolean        @default(false) // Shown in featured slot on blog index
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt

  @@index([status, publishedAt])
  @@index([slug])
}

enum StaffAttendanceStatus {
  PRESENT
  ABSENT
  UNKNOWN
}

// --- Models ---

// NEW: Org (Suite) — business/billing owner; may contain multiple Tenants (sites)
model Org {
  id               String                   @id @default(uuid())
  name             String
  slug             String                   @unique
  planCode         String // e.g., trial|starter|standard|pro|suite_*
  isSuite          Boolean                  @default(false)
  isMasterOrg      Boolean                  @default(false) // Internal/platform org: no Stripe, unlimited, non-billable
  stripeCustomerId String?                  @unique
  tenants          Tenant[]
  subscriptions    Subscription[]
  entitlements     OrgEntitlementSnapshot[]
  retentionPolicy  OrgRetentionPolicy?
  usageCounters    UsageCounters[]
  billingEvents    BillingEvent[]
  userOrgRoles     UserOrgRole[]
  orgMemberships   OrgMembership[]
  auditEvents       AuditEvent[]
  staffActivities   StaffActivity[]
  pendingOrders     PendingOrder[]
  invites           Invite[]
  publicSignupLinks PublicSignupLink[]
  createdAt         DateTime                 @default(now())
  updatedAt         DateTime                 @updatedAt
}

// NOTE: Tenant == Site (true isolation boundary / RLS). Admin UI “Site selector”
// maps directly to this model. Future migrations may introduce a dedicated `Site`
// wrapper but the tenant id remains the canonical RLS key.
model Tenant {
  id       String  @id @default(uuid())
  name     String
  slug     String  @unique
  timezone String? // IANA timezone e.g. Europe/London

  // NEW: link tenant (site) to its owning Org
  orgId String
  org   Org    @relation(fields: [orgId], references: [id])

  users           User[]
  groups          Group[]
  children        Child[]
  roles           UserTenantRole[]
  sessions        Session[]
  lessons         Lesson[]
  announcements   Announcement[]
  preferences     VolunteerPreference[]
  auditEvents     AuditEvent[]
  staffActivities StaffActivity[]
  pendingOrders   PendingOrder[]
  siteMemberships        SiteMembership[]
  lastActiveUsers        User[]                  @relation("UserLastActiveTenant")
  staffUnavailableDates  StaffUnavailableDate[]
  staffPreferredGroups   StaffPreferredGroup[]
  sessionStaffAttendance SessionStaffAttendance[]
  publicSignupLinks      PublicSignupLink[]
  emergencyContacts      EmergencyContact[]
  parentSignupConsents   ParentSignupConsent[]
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt

  @@index([orgId])
}

model UserTenantRole {
  id       String @id @default(uuid())
  userId   String
  tenantId String
  role     Role

  user   User   @relation(fields: [userId], references: [id])
  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@unique([userId, tenantId, role])
}

// NEW: User ↔ Org roles (optional, for suite-level administration)
model UserOrgRole {
  id     String  @id @default(uuid())
  userId String
  orgId  String
  role   OrgRole

  user User @relation(fields: [userId], references: [id])
  org  Org  @relation(fields: [orgId], references: [id])

  @@unique([userId, orgId, role])
  @@index([orgId])
}

model User {
  id          String    @id @default(uuid())
  email       String?   @unique
  name        String?
  displayName String?
  firstName   String?
  lastName    String?
  dateOfBirth        DateTime? @db.Date
  avatarUrl          String?   // External URL fallback (e.g. Auth0)
  avatarBytes        Bytes?    // Inline storage until S3
  avatarContentType  String?   // e.g. image/jpeg
  isActive           Boolean   @default(true)
  superUser          Boolean   @default(false) // Nexsteps staff only (e.g. blog admin)

  // NOTE: kept for backward compatibility (single-tenant user). For suites, prefer UserTenantRole.
  tenantId String?
  tenant   Tenant? @relation(fields: [tenantId], references: [id])

  // Preferred site (tenant) remembered by the API when multiple memberships exist.
  lastActiveTenantId String?
  lastActiveTenant   Tenant? @relation("UserLastActiveTenant", fields: [lastActiveTenantId], references: [id])

  children         Child[]               @relation("ParentChildren")
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt
  firstLoginAt     DateTime?                // Track when user first logs in (for onboarding)
  hasServeAccess   Boolean               @default(false)
  hasFamilyAccess  Boolean               @default(false)
  roles            UserTenantRole[]
  siteMemberships  SiteMembership[]
  orgMemberships   OrgMembership[]
  assignments      Assignment[]
  preferences      VolunteerPreference[]
  notes            ChildNote[]           @relation("ChildNoteAuthor")
  approvedNotes    ChildNote[]           @relation("ChildNoteApprovedBy")
  auditEvents      AuditEvent[]          @relation("AuditActor")
  swapRequestsFrom SwapRequest[]         @relation("SwapFromUser")
  swapRequestsTo   SwapRequest[]         @relation("SwapToUser")
  orgRoles         UserOrgRole[]
  staffActivities      StaffActivity[]
  identities           UserIdentity[]
  invitesCreated          Invite[]                  @relation("InviteCreatedBy")
  publicSignupLinksCreated PublicSignupLink[]       @relation("PublicSignupLinkCreatedBy")
  staffUnavailableDates   StaffUnavailableDate[]
  staffPreferredGroups    StaffPreferredGroup[]
  emergencyContacts       EmergencyContact[]
  parentSignupConsents    ParentSignupConsent[]
  staffAttendanceAsStaff  SessionStaffAttendance[] @relation("StaffAttendanceForUser")
  staffAttendanceMarkedBy SessionStaffAttendance[] @relation("StaffAttendanceMarkedBy")
}

// Auth identity linking external providers (e.g., Auth0) to internal users.
model UserIdentity {
  id              String   @id @default(uuid())
  userId          String
  provider        String
  providerSubject String
  email           String?
  displayName     String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@unique([provider, providerSubject])
  @@index([userId])
}

// Membership of a user to an Org (suite-level). Useful for listing sites the user can manage.
model OrgMembership {
  id        String   @id @default(uuid())
  orgId     String
  userId    String
  role      OrgRole  @default(ORG_MEMBER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  org  Org  @relation(fields: [orgId], references: [id])
  user User @relation(fields: [userId], references: [id])

  @@unique([orgId, userId])
  @@index([userId])
}

// Membership of a user to a Site (Tenant). This is the primary tenant access control.
model SiteMembership {
  id        String   @id @default(uuid())
  tenantId  String
  userId    String
  role      SiteRole @default(STAFF)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id])
  user   User   @relation(fields: [userId], references: [id])

  @@unique([tenantId, userId])
  @@index([userId])
  @@index([tenantId])
}

// Invite model for onboarding new users to Orgs and Sites
model Invite {
  id              String @id @default(uuid())
  orgId           String
  org             Org    @relation(fields: [orgId], references: [id])
  createdByUserId String
  createdBy       User   @relation("InviteCreatedBy", fields: [createdByUserId], references: [id])
  email           String // normalized to lowercase
  name            String? // Optional name for the invitee

  // Org-level role (optional, if granting org access)
  orgRole OrgRole?

  // Site-level access (optional, if granting site access)
  siteIdsJson String? // JSON array of site IDs ["site1", "site2"]
  siteRole    SiteRole?

  // Token and expiry
  tokenHash String   @unique // Store hash only, never raw token
  expiresAt DateTime

  // Lifecycle timestamps
  usedAt     DateTime?
  revokedAt  DateTime?
  lastSentAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orgId, email])
  @@index([tokenHash])
  @@index([email])
}

// Invite-only public parent signup link (site-specific; token in QR link).
// tokenForDisplay: stored only for admin re-display of the same QR; never logged; verification uses tokenHash only.
model PublicSignupLink {
  id              String    @id @default(uuid())
  orgId           String
  tenantId        String
  tokenHash       String
  tokenForDisplay String?   // For returning same signup URL to admin; never log or expose outside admin response
  createdByUserId String?
  createdBy       User?     @relation("PublicSignupLinkCreatedBy", fields: [createdByUserId], references: [id])
  expiresAt       DateTime?
  revokedAt       DateTime?
  lastUsedAt      DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  org    Org    @relation(fields: [orgId], references: [id])
  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, tokenHash])
  @@index([tenantId, revokedAt, expiresAt])
  @@index([orgId])
}

// Emergency contact for a parent (guardian) in a tenant.
model EmergencyContact {
  id          String   @id @default(uuid())
  userId      String
  tenantId    String
  name        String
  phone       String
  relationship String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tenantId])
}

// Consent record for parent signup (timestamps + consenting adult identity).
model ParentSignupConsent {
  id                        String    @id @default(uuid())
  userId                    String
  tenantId                  String
  dataProcessingConsentAt   DateTime
  firstAidConsentAt        DateTime?
  consentingAdultName       String
  consentingAdultRelationship String?
  createdAt                 DateTime  @default(now())
  updatedAt                 DateTime  @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tenantId])
}

model Child {
  id                  String       @id @default(uuid())
  firstName           String
  lastName            String
  preferredName       String?
  dateOfBirth         DateTime?
  allergies           String       @default("unknown")
  additionalNeedsNotes String?
  // Safeguarding-relevant info from public signup
  schoolName          String?
  yearGroup           String?
  gpName              String?
  gpPhone             String?
  specialNeedsType    String?      // e.g. none, sen_support, ehcp, other
  specialNeedsOther   String?     // Free text when specialNeedsType is "other"
  photoConsent        Boolean      @default(false)
  photoKey            String?
  photoBytes          Bytes?       // Inline storage until S3; serve via signed URL later
  photoContentType    String?      // e.g. image/jpeg
  notes               String?
  tenantId            String
  tenant              Tenant       @relation(fields: [tenantId], references: [id])
  guardians           User[]       @relation("ParentChildren")
  groupId             String?
  group               Group?       @relation(fields: [groupId], references: [id])
  disabilities        String[]     @default([])
  concerns            Concern[]
  attendance          Attendance[]
  childNotes          ChildNote[]
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt

  @@index([tenantId])
}

model Group {
  id          String       @id @default(uuid())
  name        String
  minAge      Int?
  maxAge      Int?
  description String?
  color       String?      // Hex color for rota/schedule cards (e.g. #0ec2a2)
  isActive    Boolean      @default(true)
  sortOrder   Int?
  tenantId    String
  tenant      Tenant       @relation(fields: [tenantId], references: [id])
  children              Child[]
  attendances           Attendance[]
  sessions              Session[]   // many-to-many with Session
  lessons               Lesson[]
  staffPreferredGroups  StaffPreferredGroup[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@unique([tenantId, name])
  @@index([tenantId])
}

model Attendance {
  id        String   @id @default(uuid())
  childId   String
  child     Child    @relation(fields: [childId], references: [id])
  groupId   String
  group     Group    @relation(fields: [groupId], references: [id])
  sessionId String?
  session   Session? @relation(fields: [sessionId], references: [id])
  present   Boolean
  timestamp DateTime @default(now())

  @@index([childId])
  @@index([sessionId])
  @@index([groupId])
}

model Concern {
  id        String    @id @default(uuid())
  childId   String
  child     Child     @relation(fields: [childId], references: [id])
  summary   String
  details   String?
  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([childId])
}

model Session {
  id                    String                   @id @default(uuid())
  tenantId              String
  tenant                Tenant                   @relation(fields: [tenantId], references: [id])
  groups                Group[]                  // many-to-many: session can be for multiple classes
  startsAt              DateTime
  endsAt                DateTime
  title                 String?
  assignments           Assignment[]
  attendances           Attendance[]
  lessons               Lesson[]                 // lessons linked to this session
  sessionStaffAttendance SessionStaffAttendance[]
  createdAt             DateTime                 @default(now())
  updatedAt             DateTime                 @updatedAt

  @@index([tenantId])
  @@index([startsAt])
}

model Assignment {
  id           String           @id @default(uuid())
  sessionId    String
  session      Session          @relation(fields: [sessionId], references: [id])
  userId       String
  user         User             @relation(fields: [userId], references: [id])
  role         Role
  status       AssignmentStatus @default(CONFIRMED)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  swapRequests SwapRequest[]    @relation("AssignmentSwapRequests")

  @@unique([sessionId, userId, role])
  @@index([userId])
}

model SessionStaffAttendance {
  id             String                @id @default(uuid())
  tenantId       String
  tenant         Tenant                @relation(fields: [tenantId], references: [id])
  sessionId      String
  session        Session               @relation(fields: [sessionId], references: [id])
  staffUserId    String
  staffUser      User                  @relation("StaffAttendanceForUser", fields: [staffUserId], references: [id])
  status         StaffAttendanceStatus @default(UNKNOWN)
  markedByUserId String?
  markedByUser   User?                 @relation("StaffAttendanceMarkedBy", fields: [markedByUserId], references: [id])
  markedAt       DateTime?
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt

  @@unique([tenantId, sessionId, staffUserId])
  @@index([tenantId])
  @@index([sessionId])
  @@index([staffUserId])
}

model VolunteerPreference {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  weekday     Weekday
  startMinute Int // minutes from 00:00 (0-1439)
  endMinute   Int // minutes from 00:00 (1-1440)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([userId, tenantId, weekday, startMinute, endMinute])
  @@index([tenantId])
}

model StaffUnavailableDate {
  id        String   @id @default(uuid())
  userId    String
  tenantId  String
  date      DateTime @db.Date
  reason    String?
  createdAt DateTime @default(now())

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([userId, tenantId, date])
  @@index([tenantId])
  @@index([userId])
}

model StaffPreferredGroup {
  id        String   @id @default(uuid())
  userId    String
  tenantId  String
  groupId   String
  createdAt DateTime @default(now())

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  group  Group  @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([userId, tenantId, groupId])
  @@index([tenantId])
  @@index([userId])
}

model SwapRequest {
  id           String     @id @default(uuid())
  assignmentId String
  assignment   Assignment @relation("AssignmentSwapRequests", fields: [assignmentId], references: [id])
  fromUserId   String
  fromUser     User       @relation("SwapFromUser", fields: [fromUserId], references: [id])
  toUserId     String?
  toUser       User?      @relation("SwapToUser", fields: [toUserId], references: [id])
  status       SwapStatus @default(REQUESTED)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@index([fromUserId])
  @@index([toUserId])
}

model Lesson {
  id                 String    @id @default(uuid())
  tenantId           String
  tenant             Tenant    @relation(fields: [tenantId], references: [id])
  groupId            String?
  group              Group?    @relation(fields: [groupId], references: [id])
  sessionId          String?   // optional link to a session (replaces date-only association)
  session            Session?  @relation(fields: [sessionId], references: [id])
  title              String
  description        String?
  fileKey            String?   // storage key / label for resource (S3 key when integrated)
  resourceFileBytes  Bytes?    // temporary: uploaded file content until S3
  resourceFileName   String?   // original filename for download
  weekOf             DateTime  // e.g., Monday of the week (kept for backward compatibility)
  createdAt          DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([tenantId])
  @@index([groupId])
  @@index([sessionId])
  @@index([weekOf])
}

model Announcement {
  id          String               @id @default(uuid())
  tenantId    String
  tenant      Tenant               @relation(fields: [tenantId], references: [id])
  title       String
  body        String
  audience    AnnouncementAudience @default(ALL)
  publishedAt DateTime?
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt

  @@index([tenantId])
  @@index([publishedAt])
  @@index([tenantId, audience, publishedAt])
}

model ChildNote {
  id               String    @id @default(uuid())
  childId          String
  child            Child     @relation(fields: [childId], references: [id])
  authorId         String
  author           User      @relation("ChildNoteAuthor", fields: [authorId], references: [id])
  text             String
  visibleToParents Boolean   @default(false)
  approvedByUserId String?
  approvedBy       User?     @relation("ChildNoteApprovedBy", fields: [approvedByUserId], references: [id])
  approvedAt       DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@index([childId])
  @@index([authorId])
}

model AuditEvent {
  id          String          @id @default(uuid())
  createdAt   DateTime        @default(now())
  tenantId    String
  tenant      Tenant          @relation(fields: [tenantId], references: [id])
  orgId       String
  org         Org             @relation(fields: [orgId], references: [id])
  actorUserId String
  actor       User            @relation("AuditActor", fields: [actorUserId], references: [id])
  entityType  AuditEntityType
  entityId    String?
  action      AuditAction
  metadata    Json?

  @@index([tenantId, createdAt])
  @@index([orgId, createdAt])
  @@index([actorUserId, createdAt])
  @@index([entityType, entityId])
}

// --- Billing & Entitlements ---

model Subscription {
  id                String             @id @default(uuid())
  orgId             String
  org               Org                @relation(fields: [orgId], references: [id])
  provider          BillingProvider
  providerSubId     String             @unique
  planCode          String
  status            SubscriptionStatus
  periodStart       DateTime
  periodEnd         DateTime
  cancelAtPeriodEnd Boolean            @default(false)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  @@index([orgId])
  @@index([status])
  @@index([planCode])
}

model OrgEntitlementSnapshot {
  id                  String   @id @default(uuid())
  orgId               String
  org                 Org      @relation(fields: [orgId], references: [id])
  maxSites            Int
  av30Included        Int
  leaderSeatsIncluded Int
  storageGbIncluded   Int
  flagsJson           Json?
  source              String // e.g., trial, subscription(pro), manual_override
  createdAt           DateTime @default(now())

  @@index([orgId, createdAt])
}

model UsageCounters {
  id           String   @id @default(uuid())
  orgId        String
  org          Org      @relation(fields: [orgId], references: [id])
  av30         Int      @default(0)
  storageGb    Int      @default(0)
  smsMonth     Int      @default(0)
  exportsMonth Int      @default(0)
  calculatedAt DateTime @default(now())

  @@index([orgId, calculatedAt])
}

model BillingEvent {
  id          String          @id @default(uuid())
  orgId       String?
  org         Org?            @relation(fields: [orgId], references: [id])
  provider    BillingProvider
  type        String
  payloadJson Json
  createdAt   DateTime        @default(now())

  @@index([orgId, createdAt])
}

model PendingOrder {
  id                     String             @id @default(uuid())
  tenantId               String?
  tenant                 Tenant?            @relation(fields: [tenantId], references: [id])
  orgId                  String?
  org                    Org?               @relation(fields: [orgId], references: [id])
  planCode               String
  av30Cap                Int?
  storageGbCap           Int?
  smsMessagesCap         Int?
  leaderSeatsIncluded    Int?
  maxSites               Int?
  flags                  Json?
  warnings               Json?
  provider               BillingProvider
  providerCheckoutId     String?
  providerCustomerId     String?
  providerSubscriptionId String?
  status                 PendingOrderStatus @default(PENDING)
  createdAt              DateTime           @default(now())
  completedAt            DateTime?
  updatedAt              DateTime           @updatedAt
  
  // For public checkout: store org/user details until payment confirmed
  pendingOrgDetails      Json?              // { orgName, slug, contactName, contactEmail, password }

  @@index([tenantId, orgId, provider, providerCheckoutId])
  @@index([provider, providerSubscriptionId])
}

model OrgRetentionPolicy {
  id                         String   @id @default(uuid())
  orgId                      String   @unique
  org                        Org      @relation(fields: [orgId], references: [id])
  attendanceRetentionDays    Int
  staffActivityRetentionDays Int
  auditEventRetentionDays    Int
  createdAt                  DateTime @default(now())
  updatedAt                  DateTime @updatedAt
}

model StaffActivity {
  id           String   @id @default(uuid())
  tenantId     String
  tenant       Tenant   @relation(fields: [tenantId], references: [id])
  orgId        String
  org          Org      @relation(fields: [orgId], references: [id])
  staffUserId  String
  staffUser    User     @relation(fields: [staffUserId], references: [id])
  activityType String // Av30ActivityType enum value
  occurredAt   DateTime @default(now())
  createdAt    DateTime @default(now())

  @@index([tenantId, occurredAt])
  @@index([tenantId, staffUserId, occurredAt])
  @@index([orgId, occurredAt])
  @@index([orgId, staffUserId, occurredAt])
}

model Lead {
  id             String    @id @default(uuid())
  kind           LeadKind
  email          String
  name           String?
  organisation   String?
  role           String?
  sector         String?
  message        String?   @db.Text
  utmSource      String?
  utmMedium      String?
  utmCampaign    String?
  metadataJson   Json?
  downloadedAt   DateTime?
  createdAt      DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  downloadTokens DownloadToken[]

  @@index([email, kind, createdAt])
  @@index([kind, createdAt])
}

model DownloadToken {
  id        String    @id @default(uuid())
  leadId    String
  lead      Lead      @relation(fields: [leadId], references: [id], onDelete: Cascade)
  tokenHash String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  @@unique([tokenHash])
  @@index([tokenHash])
  @@index([leadId])
}
